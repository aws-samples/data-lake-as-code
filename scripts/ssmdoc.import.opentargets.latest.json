{
   "schemaVersion":"2.2",
   "description":"Downloads Latest OpenTargets source files and moves them to S3",
   "parameters":{
        "openTargetsSourceFileTargetBucketLocation": {
          "type": "String",
          "description": "Bucket to store the open targets files in."
        },  
        "executionTimeout": {
          "type": "String",
          "default": "7200",
          "description": "(Optional) The time in seconds for a command to complete before it is considered to have failed. Default is 3600 (1 hour). Maximum is 172800 (48 hours).",
          "allowedPattern": "([1-9][0-9]{0,3})|(1[0-9]{1,4})|(2[0-7][0-9]{1,3})|(28[0-7][0-9]{1,2})|(28800)"
        }
    },
    "mainSteps":[
      {
        "action":"aws:runShellScript",
        "name":"DownloadAndImportOpenTargetsLatestIntoS3",
        "inputs":{
            "timeoutSeconds": "{{ executionTimeout }}",
            "runCommand": [
              "rm -rf opentargets/sourceExports/open-targets-data-releases/latest/",
              "mkdir -p opentargets/sourceExports/open-targets-data-releases/latest/",
              "mkdir -p /home/ssm-user/",
              "touch /home/ssm-user/progressLogOpenTargetsLatest",
              "echo 'Starting OpenTargets download...' >> /home/ssm-user/progressLogOpenTargetsLatest",
              "wget -r -nH --cut-dirs=5 -nc ftp://ftp.ebi.ac.uk//pub/databases/opentargets/platform/latest/output/etl/parquet/ -P opentargets/sourceExports/open-targets-data-releases/ >> /home/ssm-user/progressLogOpenTargetsLatest 2>/home/ssm-user/progressLogOpenTargetsLatest",
              "find opentargets/sourceExports/open-targets-data-releases/latest/ -type f -name '_SUCCESS' -delete",
              "aws s3 sync opentargets/sourceExports/open-targets-data-releases/latest/ s3://{{openTargetsSourceFileTargetBucketLocation}}/opentargets/sourceExports/latest/ --delete"
            ]
         }
      }
   ]
}


